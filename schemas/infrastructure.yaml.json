{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/csGIT34/infrastructure-automation/main/schemas/infrastructure.yaml.json",
  "title": "Infrastructure Pattern Request",
  "description": "Schema for infrastructure.yaml pattern request files used by the Infrastructure Self-Service Platform. Generated from config/patterns/*.yaml - DO NOT EDIT MANUALLY.",
  "type": "object",
  "required": [
    "version",
    "metadata",
    "pattern",
    "pattern_version",
    "config"
  ],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "const": "1",
      "description": "Schema version (currently only '1' is supported)"
    },
    "action": {
      "type": "string",
      "enum": [
        "create",
        "destroy"
      ],
      "default": "create",
      "description": "Action to perform: 'create' provisions resources, 'destroy' tears them down"
    },
    "metadata": {
      "type": "object",
      "description": "Project metadata for resource naming, tagging, and RBAC",
      "required": [
        "project",
        "environment",
        "business_unit",
        "owners"
      ],
      "additionalProperties": false,
      "properties": {
        "project": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]{1,20}$",
          "description": "Project name (lowercase, alphanumeric with hyphens, 2-21 chars). Used in resource naming."
        },
        "environment": {
          "type": "string",
          "enum": [
            "dev",
            "staging",
            "prod"
          ],
          "description": "Target environment. Affects sizing defaults and conditional features."
        },
        "business_unit": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]{1,30}$",
          "description": "Business unit for cost allocation and resource grouping"
        },
        "owners": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "email"
          },
          "minItems": 1,
          "description": "Email addresses of resource owners. Owners can manage security group membership."
        },
        "location": {
          "type": "string",
          "enum": [
            "eastus",
            "eastus2",
            "westus",
            "westus2",
            "westus3",
            "centralus",
            "northcentralus",
            "southcentralus",
            "westcentralus",
            "northeurope",
            "westeurope",
            "uksouth",
            "ukwest",
            "australiaeast",
            "australiasoutheast",
            "southeastasia",
            "eastasia",
            "japaneast",
            "japanwest",
            "brazilsouth",
            "canadacentral",
            "canadaeast",
            "koreacentral",
            "koreasouth",
            "francecentral",
            "germanywestcentral",
            "norwayeast",
            "switzerlandnorth",
            "uaenorth",
            "southafricanorth",
            "centralindia",
            "southindia",
            "westindia"
          ],
          "default": "eastus",
          "description": "Azure region for resource deployment"
        }
      }
    },
    "pattern": {
      "type": "string",
      "enum": [
        "aks-namespace",
        "api-backend",
        "data-pipeline",
        "eventhub",
        "function-app",
        "keyvault",
        "linux-vm",
        "microservice",
        "mongodb",
        "postgresql",
        "sql-database",
        "static-site",
        "storage",
        "web-app"
      ],
      "description": "Infrastructure pattern to provision. See pattern reference for details."
    },
    "pattern_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Semantic version of the pattern (e.g., '1.0.0'). Required for reproducibility."
    },
    "config": {
      "type": "object",
      "description": "Pattern-specific configuration",
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]{0,20}$",
          "description": "Resource name suffix (lowercase, alphanumeric with hyphens, 1-21 chars)"
        },
        "size": {
          "type": "string",
          "enum": [
            "small",
            "medium",
            "large"
          ],
          "description": "T-shirt size. Defaults: dev=small, staging=medium, prod=medium"
        },
        "aks_cluster_name": {
          "type": "string",
          "description": "Required for aks-namespace pattern"
        },
        "aks_resource_group": {
          "type": "string",
          "description": "Required for aks-namespace pattern"
        },
        "cpu_limit": {
          "type": "string",
          "description": "CPU quota for namespace (e.g., \"4\" for 4 cores) (used by: aks-namespace)"
        },
        "memory_limit": {
          "type": "string",
          "description": "Memory quota for namespace (e.g., \"8Gi\") (used by: aks-namespace)"
        },
        "pod_limit": {
          "type": "integer",
          "description": "Maximum number of pods allowed (used by: aks-namespace)"
        },
        "database_type": {
          "type": "string",
          "enum": [
            "azure_sql",
            "postgresql",
            "mongodb",
            "none"
          ],
          "default": "azure_sql"
        },
        "runtime": {
          "type": "string",
          "enum": [
            "python",
            "node",
            "dotnet",
            "java"
          ],
          "default": "python"
        },
        "runtime_version": {
          "type": "string"
        },
        "enable_mongodb": {
          "type": "boolean",
          "default": true,
          "description": "Include Cosmos DB for processed data (used by: data-pipeline)"
        },
        "message_retention": {
          "type": "integer",
          "default": 1,
          "description": "Event Hub message retention in days (used by: data-pipeline, eventhub)"
        },
        "partition_count": {
          "type": "integer",
          "default": 2,
          "description": "Number of partitions per Event Hub (used by: eventhub)"
        },
        "enable_private_endpoint": {
          "type": "boolean",
          "default": false,
          "description": "Enable private endpoint connectivity (used by: eventhub, keyvault, mongodb, postgresql, sql-database, storage)"
        },
        "subnet_id": {
          "type": "string",
          "description": "Subnet ID for private endpoint (used by: eventhub, keyvault, mongodb, postgresql, sql-database, storage)"
        },
        "os_type": {
          "type": "string",
          "enum": [
            "Linux",
            "Windows"
          ],
          "default": "Linux"
        },
        "app_settings": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Additional app settings (used by: function-app)"
        },
        "cors_origins": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "enable_access_review": {
          "type": "boolean",
          "default": false,
          "description": "Enable quarterly access reviews for privileged groups (used by: keyvault)"
        },
        "access_reviewers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Email addresses of access reviewers (required for prod) (used by: keyvault)"
        },
        "admin_username": {
          "type": "string",
          "default": "azureuser",
          "description": "SSH admin username (used by: linux-vm)"
        },
        "image_publisher": {
          "type": "string",
          "default": "Canonical",
          "description": "VM image publisher (used by: linux-vm)"
        },
        "image_offer": {
          "type": "string",
          "default": "0001-com-ubuntu-server-jammy",
          "description": "VM image offer (used by: linux-vm)"
        },
        "image_sku": {
          "type": "string",
          "enum": [
            "20_04-lts",
            "22_04-lts",
            "24_04-lts"
          ],
          "default": "22_04-lts",
          "description": "Ubuntu version (used by: linux-vm)"
        },
        "enable_eventhub": {
          "type": "boolean",
          "default": true
        },
        "enable_storage": {
          "type": "boolean",
          "default": true
        },
        "consistency_level": {
          "type": "string",
          "enum": [
            "Eventual",
            "Session",
            "BoundedStaleness",
            "Strong"
          ],
          "default": "Session",
          "description": "Consistency level for reads (used by: mongodb)"
        },
        "enable_automatic_failover": {
          "type": "boolean",
          "default": false,
          "description": "Enable automatic failover to secondary region (used by: mongodb)"
        },
        "version": {
          "type": "string",
          "enum": [
            "12",
            "13",
            "14",
            "15",
            "16"
          ],
          "default": "14",
          "description": "PostgreSQL version (used by: api-backend, function-app, postgresql, web-app)"
        },
        "allowed_ips": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "IP addresses allowed through firewall (used by: postgresql, sql-database)"
        },
        "repository_url": {
          "type": "string",
          "description": "GitHub repository URL for automatic deployments (used by: static-site)"
        },
        "branch": {
          "type": "string",
          "default": "main",
          "description": "Branch to deploy from (used by: static-site)"
        },
        "app_location": {
          "type": "string",
          "default": "/",
          "description": "Location of app source code relative to repo root (used by: static-site)"
        },
        "api_location": {
          "type": "string",
          "default": "",
          "description": "Location of Azure Functions API (if any) (used by: static-site)"
        },
        "output_location": {
          "type": "string",
          "default": "build",
          "description": "Build output directory (used by: static-site)"
        },
        "containers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of blob containers to create (used by: storage)"
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "pattern": {
            "const": "aks-namespace"
          }
        }
      },
      "then": {
        "properties": {
          "config": {
            "required": [
              "name",
              "aks_cluster_name",
              "aks_resource_group"
            ]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "pattern": {
            "const": "linux-vm"
          }
        }
      },
      "then": {
        "properties": {
          "config": {
            "required": [
              "name",
              "subnet_id"
            ]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "pattern": {
            "const": "microservice"
          }
        }
      },
      "then": {
        "properties": {
          "config": {
            "required": [
              "name",
              "aks_cluster_name",
              "aks_resource_group"
            ]
          }
        }
      }
    }
  ],
  "examples": [
    {
      "version": "1",
      "metadata": {
        "project": "myapp",
        "environment": "dev",
        "business_unit": "engineering",
        "owners": [
          "alice@company.com",
          "bob@company.com"
        ],
        "location": "eastus"
      },
      "pattern": "keyvault",
      "pattern_version": "1.0.0",
      "config": {
        "name": "secrets",
        "size": "small"
      }
    },
    {
      "version": "1",
      "action": "destroy",
      "metadata": {
        "project": "myapp",
        "environment": "dev",
        "business_unit": "engineering",
        "owners": [
          "alice@company.com"
        ]
      },
      "pattern": "postgresql",
      "pattern_version": "1.0.0",
      "config": {
        "name": "olddb"
      }
    }
  ]
}
