name: Test Pattern TFVars

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      pattern:
        description: 'Pattern to test'
        required: false
        type: choice
        options:
          - all
          - keyvault
          - postgresql
          - storage
          - eventhub
          - function-app
          - sql-database
          - mongodb
          - linux-vm
          - static-site
          - aks-namespace
          - microservice
          - web-app
          - api-backend
          - data-pipeline
      size:
        description: 'Size to test'
        required: false
        type: choice
        options:
          - all
          - small
          - medium
          - large

  # Run on PR when tfvars or pattern files change
  pull_request:
    paths:
      - 'terraform/patterns/**/*.tfvars'
      - 'terraform/patterns/**/*.tf'
      - 'terraform/modules/**'
      - '.github/workflows/test-tfvars.yaml'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TERRAFORM_VERSION: '1.5.0'

jobs:
  # Detect which patterns to test
  detect-patterns:
    name: Detect Patterns to Test
    runs-on: ubuntu-latest
    outputs:
      patterns: ${{ steps.detect.outputs.patterns }}
      sizes: ${{ steps.detect.outputs.sizes }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect patterns and sizes
        id: detect
        run: |
          # Determine patterns to test
          if [ "${{ inputs.pattern }}" == "all" ] || [ -z "${{ inputs.pattern }}" ]; then
            # Test all patterns
            PATTERNS='["keyvault","postgresql","storage","eventhub","function-app","sql-database","mongodb","linux-vm","static-site","aks-namespace","microservice","web-app","api-backend","data-pipeline"]'
          elif [ -n "${{ inputs.pattern }}" ]; then
            # Manual trigger with specific pattern
            PATTERNS='["${{ inputs.pattern }}"]'
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR - detect changed patterns
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD)

            PATTERNS_LIST=""
            for file in $CHANGED_FILES; do
              if [[ "$file" =~ terraform/patterns/([^/]+)/ ]]; then
                pattern="${BASH_REMATCH[1]}"
                if [[ ! "$PATTERNS_LIST" =~ "$pattern" ]]; then
                  PATTERNS_LIST="$PATTERNS_LIST $pattern"
                fi
              fi
            done

            # Check if modules changed - test all patterns
            if echo "$CHANGED_FILES" | grep -q "terraform/modules/"; then
              echo "Modules changed - testing all patterns"
              PATTERNS_LIST="keyvault postgresql storage eventhub function-app sql-database mongodb linux-vm static-site aks-namespace microservice web-app api-backend data-pipeline"
            fi

            if [ -z "$PATTERNS_LIST" ]; then
              echo "No patterns to test"
              PATTERNS='[]'
            else
              PATTERNS=$(echo $PATTERNS_LIST | tr ' ' '\n' | jq -R . | jq -sc .)
            fi
          fi

          # Determine sizes to test
          if [ "${{ inputs.size }}" == "all" ] || [ -z "${{ inputs.size }}" ]; then
            SIZES='["small","medium","large"]'
          else
            SIZES='["${{ inputs.size }}"]'
          fi

          echo "patterns=$PATTERNS" >> $GITHUB_OUTPUT
          echo "sizes=$SIZES" >> $GITHUB_OUTPUT

          echo "Testing patterns: $PATTERNS"
          echo "Testing sizes: $SIZES"

  # Validate tfvars syntax
  validate-tfvars:
    name: Validate TFVars - ${{ matrix.pattern }}/${{ matrix.size }}
    runs-on: ubuntu-latest
    needs: detect-patterns
    if: needs.detect-patterns.outputs.patterns != '[]'

    strategy:
      fail-fast: false
      matrix:
        pattern: ${{ fromJSON(needs.detect-patterns.outputs.patterns) }}
        size: ${{ fromJSON(needs.detect-patterns.outputs.sizes) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Check tfvars file exists
        id: check
        run: |
          if [ -f "terraform/patterns/${{ matrix.pattern }}/${{ matrix.size }}.tfvars" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::error::Missing tfvars file: terraform/patterns/${{ matrix.pattern }}/${{ matrix.size }}.tfvars"
            exit 1
          fi

      - name: Terraform Init
        if: steps.check.outputs.exists == 'true'
        working-directory: terraform/patterns/${{ matrix.pattern }}
        run: terraform init -backend=false

      - name: Terraform Validate
        if: steps.check.outputs.exists == 'true'
        working-directory: terraform/patterns/${{ matrix.pattern }}
        run: terraform validate

      - name: Terraform Format Check
        if: steps.check.outputs.exists == 'true'
        working-directory: terraform/patterns/${{ matrix.pattern }}
        run: |
          terraform fmt -check ${{ matrix.size }}.tfvars || {
            echo "::warning::TFVars file needs formatting. Run: terraform fmt ${{ matrix.size }}.tfvars"
          }

  # Test with terraform plan (requires Azure auth)
  test-plan:
    name: Plan Test - ${{ matrix.pattern }}/${{ matrix.size }}
    runs-on: ubuntu-latest
    needs: [detect-patterns, validate-tfvars]
    if: needs.detect-patterns.outputs.patterns != '[]'
    continue-on-error: true  # Don't fail workflow if Azure isn't configured
    environment: dev

    strategy:
      fail-fast: false
      matrix:
        pattern: ${{ fromJSON(needs.detect-patterns.outputs.patterns) }}
        size: ${{ fromJSON(needs.detect-patterns.outputs.sizes) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_dev }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        working-directory: terraform/patterns/${{ matrix.pattern }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_dev }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          terraform init \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=test/${{ matrix.pattern }}-${{ matrix.size }}.tfstate"

      - name: Terraform Plan
        working-directory: terraform/patterns/${{ matrix.pattern }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_dev }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          terraform plan \
            -var-file=${{ matrix.size }}.tfvars \
            -out=tfplan
        timeout-minutes: 10

      - name: Save plan output
        if: github.event_name == 'pull_request'
        working-directory: terraform/patterns/${{ matrix.pattern }}
        run: |
          terraform show -no-color tfplan > plan.txt

      - name: Comment plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/patterns/${{ matrix.pattern }}/plan.txt', 'utf8');
            const truncated = plan.length > 60000 ? plan.substring(0, 60000) + '\n\n... (truncated)' : plan;

            const body = `### Terraform Plan: ${{ matrix.pattern }}/${{ matrix.size }}.tfvars

            <details>
            <summary>Show Plan</summary>

            \`\`\`terraform
            ${truncated}
            \`\`\`

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Summary
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-patterns, validate-tfvars, test-plan]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-patterns.outputs.patterns }}" == "[]" ]; then
            echo "No patterns to test" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "### Patterns Tested" >> $GITHUB_STEP_SUMMARY
          echo "Patterns: ${{ needs.detect-patterns.outputs.patterns }}" >> $GITHUB_STEP_SUMMARY
          echo "Sizes: ${{ needs.detect-patterns.outputs.sizes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate-tfvars.result == 'success' && '✅' || '❌' }} ${{ needs.validate-tfvars.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan Tests | ${{ needs.test-plan.result == 'success' && '✅' || '⚠️' }} ${{ needs.test-plan.result }} (optional) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-tfvars.result }}" == "success" ]; then
            echo "### ✅ Validation passed!" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.test-plan.result }}" != "success" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ **Note**: Plan tests skipped or failed (Azure credentials not configured)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ❌ Validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
