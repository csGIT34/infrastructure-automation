# Terraform Module Tests
#
# Runs terraform test for all modules and patterns.
# Tests create real Azure resources and clean up automatically.

name: Terraform Tests

on:
  # Manual trigger for local development workflow
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - modules
          - patterns
      specific_test:
        description: 'Specific module/pattern name (leave empty for all)'
        required: false
        type: string

  # Run on PRs touching terraform files
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-test.yaml'

  # Scheduled run to catch regressions
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC

env:
  TERRAFORM_VERSION: '1.6.0'
  TF_IN_AUTOMATION: 'true'

jobs:
  # Quick validation - naming module only (no Azure resources)
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Test naming module (no Azure)
        working-directory: terraform/tests/modules/naming
        run: |
          terraform init
          terraform test

  # Module tests - run in parallel
  test-modules:
    name: Test Module - ${{ matrix.module }}
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.test_type == 'all' ||
      github.event.inputs.test_type == 'modules'

    permissions:
      id-token: write
      contents: read

    strategy:
      fail-fast: false
      matrix:
        module:
          - keyvault
          - storage-account
          - security-groups
          - rbac-assignments
          - postgresql
        exclude:
          # Skip if specific test requested and doesn't match
          - module: ${{ github.event.inputs.specific_test != '' && github.event.inputs.specific_test != matrix.module && matrix.module || '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_dev }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create test config
        working-directory: terraform/tests/setup
        run: |
          cat > terraform.tfvars <<EOF
          test_subscription_id = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          test_tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          test_location        = "eastus"
          test_owner_email     = "${{ secrets.TEST_OWNER_EMAIL }}"
          EOF

      - name: Run module test
        working-directory: terraform/tests/modules/${{ matrix.module }}
        run: |
          terraform init
          terraform test -var-file=../../setup/terraform.tfvars
        timeout-minutes: 30

  # Pattern tests - run after module tests
  test-patterns:
    name: Test Pattern - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    needs: test-modules
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.test_type == 'all' ||
      github.event.inputs.test_type == 'patterns'

    permissions:
      id-token: write
      contents: read

    strategy:
      fail-fast: false
      matrix:
        pattern:
          - keyvault
        exclude:
          - pattern: ${{ github.event.inputs.specific_test != '' && github.event.inputs.specific_test != matrix.pattern && matrix.pattern || '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_dev }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create test config
        working-directory: terraform/tests/setup
        run: |
          cat > terraform.tfvars <<EOF
          test_subscription_id = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          test_tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          test_location        = "eastus"
          test_owner_email     = "${{ secrets.TEST_OWNER_EMAIL }}"
          EOF

      - name: Run pattern test
        working-directory: terraform/tests/patterns/${{ matrix.pattern }}
        run: |
          terraform init
          terraform test -var-file=../../setup/terraform.tfvars
        timeout-minutes: 45

  # Cleanup orphaned resources (runs on schedule only)
  cleanup:
    name: Cleanup Orphaned Resources
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_dev }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Find and delete orphaned test resources
        run: |
          echo "Finding orphaned test resource groups..."
          groups=$(az group list --query "[?starts_with(name, 'rg-tftest-')].name" -o tsv)

          if [ -z "$groups" ]; then
            echo "No orphaned test resource groups found"
          else
            echo "Found orphaned groups:"
            echo "$groups"

            for group in $groups; do
              echo "Deleting $group..."
              az group delete --name "$group" --yes --no-wait
            done

            echo "Cleanup initiated"
          fi

      - name: Find and delete orphaned security groups
        run: |
          echo "Finding orphaned test security groups..."
          # Note: This requires appropriate Graph permissions
          az ad group list --query "[?starts_with(displayName, 'sg-tftest-')].displayName" -o tsv | while read group; do
            echo "Deleting group: $group"
            az ad group delete --group "$group" || true
          done
