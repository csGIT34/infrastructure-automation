name: Validate Pattern Sync

on:
  pull_request:
    paths:
      - 'mcp-server/src/index.ts'
      - 'templates/infrastructure-workflow.yaml'
      - 'config/patterns/*.yaml'
      - 'terraform/patterns/*/main.tf'
  push:
    branches:
      - main
    paths:
      - 'mcp-server/src/index.ts'
      - 'templates/infrastructure-workflow.yaml'
      - 'config/patterns/*.yaml'
      - 'terraform/patterns/*/main.tf'

jobs:
  validate-sync:
    name: Validate patterns are in sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Extract patterns from all sources
        id: extract
        run: |
          python << 'EOF'
          import os
          import re
          import json
          import yaml
          from pathlib import Path

          errors = []
          warnings = []

          # 1. Get patterns from terraform/patterns directories
          tf_patterns = []
          patterns_dir = Path('terraform/patterns')
          if patterns_dir.exists():
              for p in patterns_dir.iterdir():
                  if p.is_dir() and (p / 'main.tf').exists():
                      tf_patterns.append(p.name)
          tf_patterns.sort()
          print(f"Terraform patterns: {tf_patterns}")

          # 2. Get patterns from config/patterns/*.yaml
          config_patterns = []
          config_dir = Path('config/patterns')
          if config_dir.exists():
              for f in config_dir.glob('*.yaml'):
                  with open(f) as fh:
                      try:
                          data = yaml.safe_load(fh)
                          if data and 'name' in data:
                              config_patterns.append(data['name'])
                      except:
                          pass
          config_patterns.sort()
          print(f"Config patterns: {config_patterns}")

          # 3. Get valid_patterns from workflow template
          workflow_patterns = []
          template_file = Path('templates/infrastructure-workflow.yaml')
          if template_file.exists():
              with open(template_file) as f:
                  content = f.read()
                  # Look for valid_patterns = [...] in Python code block
                  match = re.search(r"valid_patterns = \[(.*?)\]", content, re.DOTALL)
                  if match:
                      pattern_str = match.group(1)
                      # Extract quoted strings
                      workflow_patterns = re.findall(r"'([^']+)'", pattern_str)
          workflow_patterns.sort()
          print(f"Workflow patterns: {workflow_patterns}")

          # 4. Get PATTERN_DEFINITIONS from MCP server (if exists)
          mcp_patterns = []
          mcp_file = Path('mcp-server/src/index.ts')
          if mcp_file.exists():
              with open(mcp_file) as f:
                  content = f.read()
                  # Look for pattern definitions - either PATTERN_DEFINITIONS or MODULE_DEFINITIONS
                  # For now, we'll look for patterns in a more flexible way
                  if 'PATTERN_DEFINITIONS' in content:
                      # Find pattern names in PATTERN_DEFINITIONS object
                      matches = re.findall(r'^\s{2}([a-z][a-z0-9_-]*): \{', content, re.MULTILINE)
                      mcp_patterns = [m for m in matches if m not in ['name', 'description', 'config', 'required', 'optional']]
                  elif 'MODULE_DEFINITIONS' in content:
                      # Legacy: extract from MODULE_DEFINITIONS
                      matches = re.findall(r'^\s{2}([a-z][a-z0-9_]+): \{', content, re.MULTILINE)
                      mcp_patterns = [m for m in matches if m not in ['name', 'description', 'config']]
          mcp_patterns.sort()
          print(f"MCP patterns: {mcp_patterns}")

          # Compare sources - Terraform patterns is the source of truth
          source_of_truth = tf_patterns

          # Check config patterns match
          missing_in_config = set(source_of_truth) - set(config_patterns)
          extra_in_config = set(config_patterns) - set(source_of_truth)
          if missing_in_config:
              warnings.append(f"Patterns in terraform/ but not in config/: {list(missing_in_config)}")
          if extra_in_config:
              warnings.append(f"Patterns in config/ but not in terraform/: {list(extra_in_config)}")

          # Check workflow patterns match
          missing_in_workflow = set(source_of_truth) - set(workflow_patterns)
          extra_in_workflow = set(workflow_patterns) - set(source_of_truth)
          if missing_in_workflow:
              errors.append(f"Patterns in terraform/ but not in workflow template: {list(missing_in_workflow)}")
          if extra_in_workflow:
              errors.append(f"Patterns in workflow template but not in terraform/: {list(extra_in_workflow)}")

          # Output results
          results = {
              'terraform_patterns': tf_patterns,
              'config_patterns': config_patterns,
              'workflow_patterns': workflow_patterns,
              'mcp_patterns': mcp_patterns,
              'errors': errors,
              'warnings': warnings,
              'in_sync': len(errors) == 0
          }

          with open('sync_results.json', 'w') as f:
              json.dump(results, f, indent=2)

          # Set outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"tf_patterns={json.dumps(tf_patterns)}\n")
              f.write(f"workflow_patterns={json.dumps(workflow_patterns)}\n")
              f.write(f"in_sync={'true' if len(errors) == 0 else 'false'}\n")

          if errors:
              print("\n::error::Pattern sync validation failed!")
              for e in errors:
                  print(f"  - {e}")
              exit(1)

          if warnings:
              print("\nWarnings:")
              for w in warnings:
                  print(f"  - {w}")

          print("\n✅ All patterns are in sync!")
          EOF

      - name: Create summary
        if: always()
        run: |
          echo "## Pattern Sync Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f sync_results.json ]; then
            echo "### Source of Truth: terraform/patterns/" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.terraform_patterns' sync_results.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### Workflow Template valid_patterns" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.workflow_patterns' sync_results.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$(jq -r '.in_sync' sync_results.json)" == "true" ]; then
              echo "### Status: ✅ In Sync" >> $GITHUB_STEP_SUMMARY
            else
              echo "### Status: ❌ Out of Sync" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Errors:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.errors[]' sync_results.json | while read e; do
                echo "- $e" >> $GITHUB_STEP_SUMMARY
              done
            fi

            WARNINGS=$(jq -r '.warnings | length' sync_results.json)
            if [ "$WARNINGS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Warnings:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.warnings[]' sync_results.json | while read w; do
                echo "- $w" >> $GITHUB_STEP_SUMMARY
              done
            fi
          fi
