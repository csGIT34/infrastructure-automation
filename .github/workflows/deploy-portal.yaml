# Deploy Infrastructure Self-Service Portal to Azure Static Web App
name: Deploy Portal

on:
  push:
    branches: [main]
    paths:
      - 'web/**'
      - 'config/patterns/*.yaml'
      - 'config/sizing-defaults.yaml'
      - 'scripts/generate-portal-data.py'
      - '.github/workflows/deploy-portal.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'web/**'
      - 'config/patterns/*.yaml'
      - 'config/sizing-defaults.yaml'
      - 'scripts/generate-portal-data.py'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Pattern Data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate pattern configs
        run: |
          echo "Validating pattern configurations..."
          python3 scripts/generate-portal-data.py --compact > /dev/null
          echo "Pattern count: $(python3 -c "import json; print(json.load(open('/dev/stdin'))['metadata']['pattern_count'])" < <(python3 scripts/generate-portal-data.py))"

      - name: Check pattern-terraform sync
        run: |
          echo "Checking pattern configs match Terraform patterns..."

          # Get pattern names from config files
          CONFIG_PATTERNS=$(ls config/patterns/*.yaml | xargs -I {} basename {} .yaml | sort)

          # Get pattern names from Terraform directories
          TF_PATTERNS=$(ls -d terraform/patterns/*/ | xargs -I {} basename {} | sort)

          # Compare
          if [ "$CONFIG_PATTERNS" != "$TF_PATTERNS" ]; then
            echo "::error::Pattern configs don't match Terraform patterns"
            echo "Config patterns: $CONFIG_PATTERNS"
            echo "Terraform patterns: $TF_PATTERNS"
            exit 1
          fi

          echo "All patterns are in sync!"

  build:
    name: Build Portal
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate pattern data and embed in HTML
        run: |
          echo "Generating pattern data..."
          python3 scripts/generate-portal-data.py --embed --html-path web/index.html
          echo "Pattern data embedded successfully"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: portal
          path: web/
          retention-days: 7

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.static_web_app_url }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: portal
          path: web/

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "web"
          skip_app_build: true
          skip_api_build: true

  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: portal
          path: web/

      - name: Deploy Preview to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "web"
          skip_app_build: true
          skip_api_build: true
