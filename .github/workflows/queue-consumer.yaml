name: Infrastructure Queue Consumer

on:
    schedule:
        - cron: '* * * * *'
    workflow_dispatch:

permissions:
    id-token: write
    contents: read

env:
    AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    SERVICEBUS_NAMESPACE: ${{ secrets.SERVICEBUS_NAMESPACE }}

jobs:
    check-queues:
        runs-on: ubuntu-latest
        outputs:
            has_prod_messages: ${{ steps.check.outputs.has_prod }}
            has_staging_messages: ${{ steps.check.outputs.has_staging }}
            has_dev_messages: ${{ steps.check.outputs.has_dev }}

        steps:
            - name: Azure Login
              uses: azure/login@v1
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Check queue depths
              id: check
              run: |
                  PROD_COUNT=$(az servicebus queue show \
                      --namespace-name $SERVICEBUS_NAMESPACE \
                      --name infrastructure-requests-prod \
                      --query "countDetails.activeMessageCount" -o tsv)

                  STAGING_COUNT=$(az servicebus queue show \
                      --namespace-name $SERVICEBUS_NAMESPACE \
                      --name infrastructure-requests-staging \
                      --query "countDetails.activeMessageCount" -o tsv)

                  DEV_COUNT=$(az servicebus queue show \
                      --namespace-name $SERVICEBUS_NAMESPACE \
                      --name infrastructure-requests-dev \
                      --query "countDetails.activeMessageCount" -o tsv)

                  echo "has_prod=$( [ $PROD_COUNT -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
                  echo "has_staging=$( [ $STAGING_COUNT -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
                  echo "has_dev=$( [ $DEV_COUNT -gt 0 ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT

    trigger-prod-workers:
        needs: check-queues
        if: needs.check-queues.outputs.has_prod_messages == 'true'
        uses: ./.github/workflows/provision-worker.yaml
        with:
            queue_name: "infrastructure-requests-prod"
            environment: "prod"
            runner_labels: '["self-hosted", "linux", "infrastructure"]'
            max_parallel: 5
        secrets: inherit

    trigger-staging-workers:
        needs: check-queues
        if: needs.check-queues.outputs.has_staging_messages == 'true'
        uses: ./.github/workflows/provision-worker.yaml
        with:
            queue_name: "infrastructure-requests-staging"
            environment: "staging"
            runner_labels: '["self-hosted", "linux", "infrastructure"]'
            max_parallel: 10
        secrets: inherit

    trigger-dev-workers:
        needs: check-queues
        if: needs.check-queues.outputs.has_dev_messages == 'true'
        uses: ./.github/workflows/provision-worker.yaml
        with:
            queue_name: "infrastructure-requests-dev"
            environment: "dev"
            runner_labels: '["self-hosted", "linux", "infrastructure"]'
            max_parallel: 20
        secrets: inherit
