# GitHub Actions Runner Deployment for Local k3s Cluster
# Apply with: kubectl apply -f runner-deployment.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: github-runners
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: infrastructure-runners
  namespace: github-runners
spec:
  # Number of runner replicas
  replicas: 2
  template:
    spec:
      # Repository-level runners
      repository: csGIT34/infrastructure-automation

      # Runner labels - use these in your workflow's runs-on
      labels:
        - self-hosted
        - linux
        - local
        - infrastructure

      # Custom image with Azure CLI, Terraform, Python pre-installed
      image: ghcr.io/csgit34/actions-runner-tools:latest
      imagePullPolicy: Always

      # Environment variables
      env:
        - name: RUNNER_FEATURE_FLAG_EPHEMERAL
          value: "false"
        # Terraform plugin cache in /tmp to avoid permission issues
        - name: TF_PLUGIN_CACHE_DIR
          value: "/tmp/terraform-plugin-cache"

      # Resource limits
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
        limits:
          cpu: "2"
          memory: "4Gi"

      # Work directory volume
      volumeMounts:
        - name: work
          mountPath: /runner/_work
        - name: terraform-cache
          mountPath: /tmp/terraform-plugin-cache
      volumes:
        - name: work
          emptyDir: {}
        - name: terraform-cache
          emptyDir: {}

      # Optional: Docker-in-Docker for container builds
      # dockerdWithinRunnerContainer: true

      # Optional: Node selector for dedicated runner nodes
      # nodeSelector:
      #   node-role.kubernetes.io/runner: "true"

      # Optional: Tolerations
      # tolerations:
      #   - key: "dedicated"
      #     operator: "Equal"
      #     value: "runner"
      #     effect: "NoSchedule"

      # Spread pods across worker nodes for high availability
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              actions-runner-controller/inject-registration-token: "true"
---
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: infrastructure-runners-autoscaler
  namespace: github-runners
spec:
  # Reference to the RunnerDeployment
  scaleTargetRef:
    name: infrastructure-runners

  # Scaling bounds
  minReplicas: 2
  maxReplicas: 10

  # Scaling metrics
  metrics:
    - type: PercentageRunnersBusy
      scaleUpThreshold: '0.75'    # Scale up when 75% of runners are busy
      scaleDownThreshold: '0.25'  # Scale down when only 25% are busy
      scaleUpFactor: '2'          # Double the runners when scaling up
      scaleDownFactor: '0.5'      # Halve the runners when scaling down
